<!DOCTYPE html>
<html style="background: #000;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crewgle</title>
    <style>
        :root { --red: #c51111; --blue: #132ed1; --visor: #83d5e6; --gold: #ffd700; }
        * { touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; background: #000; color: white; overflow: hidden; height: 100%; width: 100%; position: fixed; font-family: sans-serif; }

        /* Orientation Warning */
        #rotate-box {
            display: none; position: fixed; inset: 0; background: #000; z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        @media screen and (orientation: portrait) { #rotate-box { display: flex; } }

        /* UI */
        #ui { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        input { width: 80%; max-width: 400px; padding: 15px; border-radius: 30px; border: none; font-size: 1.2rem; outline: none; text-align: center; }

        /* Game */
        #game-layer { display: none; position: fixed; inset: 0; background: #000; z-index: 100; }
        #task-ui { position: fixed; top: 15px; left: 15px; z-index: 1000; }
        .bar { width: 150px; height: 12px; background: #333; border: 2px solid white; border-radius: 5px; }
        #fill { width: 0%; height: 100%; background: #0f0; transition: 0.3s; }

        /* Joystick */
        #joy-base { 
            position: fixed; bottom: 30px; left: 30px; width: 110px; height: 110px; 
            background: rgba(255, 255, 255, 0.1); border: 3px solid rgba(255,255,255,0.4); border-radius: 50%; z-index: 5000; 
        }
        #joy-knob { 
            position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; 
            background: #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        #meeting { display: none; position: fixed; inset: 0; z-index: 6000; background: rgba(197, 17, 17, 0.95); flex-direction: column; align-items: center; justify-content: center; }
        .nav { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 20px; z-index: 500; }
    </style>
</head>
<body>

<div id="rotate-box"><h1>ðŸ”„ ROTATE TO LANDSCAPE</h1></div>

<div id="ui">
    <h1 style="font-size: 4rem; margin-bottom: 10px;">Crewgle</h1>
    <input type="text" id="q" placeholder="Search or type /play..." autocomplete="off">
</div>

<div id="game-layer">
    <div id="task-ui">
        <div class="bar"><div id="fill"></div></div>
        <div id="status" style="color:#0f0; margin-top:5px;">Tasks: 0/4</div>
    </div>
    <canvas id="canvas"></canvas>
    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="meeting">
        <h1>EMERGENCY MEETING</h1>
        <button onclick="document.getElementById('meeting').style.display='none'" style="padding:15px 30px; font-size:1.2rem; border-radius:10px; cursor:pointer;">RESUME</button>
    </div>
</div>

<script>
    const q = document.getElementById('q');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const joyBase = document.getElementById('joy-base');
    const joyKnob = document.getElementById('joy-knob');

    let player = { x: 400, y: 300, dx: 0, dy: 0, speed: 5, side: 1 };
    let tasks = { count: 0, done: [false, false, false, false] };
    let keys = {};

    q.onkeypress = (e) => {
        if(e.key === "Enter") {
            let v = q.value.toLowerCase().trim();
            if(v === "/play") {
                document.getElementById('ui').style.display = 'none';
                document.getElementById('game-layer').style.display = 'block';
                resize();
                loop();
            } else {
                window.location.href = "https://www.bing.com/search?q=" + encodeURIComponent(v);
            }
        }
    };

    // Mobile Joystick
    function handleJoy(e) {
        e.preventDefault();
        let t = e.touches[0];
        let r = joyBase.getBoundingClientRect();
        let cx = r.left + r.width/2;
        let cy = r.top + r.height/2;
        let dx = t.clientX - cx;
        let dy = t.clientY - cy;
        let dist = Math.min(50, Math.hypot(dx, dy));
        let ang = Math.atan2(dy, dx);
        player.dx = Math.cos(ang) * (dist / 10);
        player.dy = Math.sin(ang) * (dist / 10);
        joyKnob.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
        player.side = player.dx < 0 ? -1 : 1;
    }
    joyBase.addEventListener('touchstart', handleJoy);
    joyBase.addEventListener('touchmove', handleJoy, {passive: false});
    joyBase.addEventListener('touchend', () => {
        player.dx = 0; player.dy = 0;
        joyKnob.style.transform = `translate(0,0)`;
    });

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize;
    window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
    window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

    function drawCrew(x, y, color, side) {
        ctx.fillStyle = color; ctx.strokeStyle = "black"; ctx.lineWidth = 3;
        // Body
        ctx.beginPath(); ctx.roundRect(x - 15, y - 20, 30, 40, [15, 15, 5, 5]); ctx.fill(); ctx.stroke();
        // Visor
        ctx.fillStyle = "#83d5e6";
        ctx.beginPath(); ctx.roundRect(side < 0 ? x-18 : x+2, y-12, 16, 10, 5); ctx.fill(); ctx.stroke();
    }

    function loop() {
        if(document.getElementById('meeting').style.display === 'flex') return requestAnimationFrame(loop);
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);

        // Skeld Rooms
        ctx.fillStyle = "#3e444e";
        let midX = canvas.width/2, midY = canvas.height/2;
        ctx.fillRect(midX - 200, midY - 150, 400, 300); // Cafeteria
        ctx.fillRect(midX - 450, midY - 50, 250, 100);  // Medbay
        ctx.fillRect(midX + 200, midY - 50, 250, 100);  // Nav

        // Gold Statue
        drawCrew(midX + 150, midY - 110, "gold", 1);

        // Emergency Table
        ctx.fillStyle = "#2c313a"; ctx.beginPath(); ctx.arc(midX, midY, 50, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(midX, midY, 15, 0, Math.PI*2); ctx.fill();

        // Tasks
        const pts = [{x:midX-400, y:midY}, {x:midX+400, y:midY}, {x:midX, y:midY-120}, {x:midX, y:midY+120}];
        pts.forEach((p, i) => {
            if(!tasks.done[i]) {
                ctx.fillStyle = "yellow"; ctx.fillRect(p.x-15, p.y-15, 30, 30);
                if(Math.hypot(player.x-p.x, player.y-p.y) < 40) {
                    tasks.done[i] = true; tasks.count++;
                    document.getElementById('fill').style.width = (tasks.count/4*100)+'%';
                    document.getElementById('status').innerText = `Tasks: ${tasks.count}/4`;
                }
            }
        });

        // Controls
        if(keys['w'] || keys['arrowup']) player.y -= 5;
        if(keys['s'] || keys['arrowdown']) player.y += 5;
        if(keys['a'] || keys['arrowleft']) { player.x -= 5; player.side = -1; }
        if(keys['d'] || keys['arrowright']) { player.x += 5; player.side = 1; }
        player.x += player.dx; player.y += player.dy;

        // Emergency Call (E or proximity on mobile)
        if(Math.hypot(player.x - midX, player.y - midY) < 40 && (keys['e'])) {
            document.getElementById('meeting').style.display = 'flex';
        }

        drawCrew(player.x, player.y, "red", player.side);
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>

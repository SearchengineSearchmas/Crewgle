<!DOCTYPE html>
<html style="background: #000;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crewgle</title>
    <style>
        :root { --red: #c51111; --blue: #132ed1; --visor: #83d5e6; }
        * { touch-action: none; user-select: none; box-sizing: border-box; }
        body, html { margin: 0; padding: 0; background: #000; color: white; height: 100%; width: 100%; font-family: sans-serif; overflow: hidden; }

        /* Stealth UI */
        #ui { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .logo { font-size: 5rem; font-weight: bold; margin-bottom: 20px; }
        #q { width: 80%; max-width: 500px; padding: 18px; border-radius: 50px; border: 1px solid #333; background: #111; color: #fff; text-align: center; outline: none; }

        /* Game */
        #game { display: none; position: fixed; inset: 0; z-index: 100; background: #000; }
        #rotate-box { display: none; position: absolute; inset: 0; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        @media screen and (orientation: portrait) { #game #rotate-box { display: flex; } }

        /* HUD */
        #task-ui { position: fixed; top: 15px; left: 15px; z-index: 1000; }
        .bar { width: 140px; height: 10px; background: #222; border: 1px solid #fff; }
        #fill { width: 0%; height: 100%; background: #0f0; transition: 0.3s; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
        .panel { background: #222; padding: 30px; border: 4px solid #444; border-radius: 20px; text-align: center; min-width: 300px; }
        
        /* Engine Task Visuals */
        #engine-gauge { width: 200px; height: 200px; border: 5px solid #555; border-radius: 50%; margin: 20px auto; position: relative; background: #111; }
        #needle { width: 4px; height: 90px; background: #f00; position: absolute; bottom: 50%; left: calc(50% - 2px); transform-origin: bottom; transform: rotate(0deg); transition: 0.1s; }
        #target-zone { width: 30px; height: 30px; border: 3px solid #0f0; position: absolute; top: 10px; left: calc(50% - 15px); border-radius: 50%; }

        #joy { position: fixed; bottom: 30px; left: 30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; z-index: 5000; }
        #knob { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        
        .btn { padding: 10px 20px; background: #444; color: #fff; border: none; border-radius: 5px; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

<div id="ui">
    <div class="logo">Crewgle</div>
    <input type="text" id="q" placeholder="Search the web..." autocomplete="off">
</div>

<div id="game">
    <div id="rotate-box"><h1>ðŸ”„ ROTATE PHONE</h1></div>
    <div id="task-ui">
        <div class="bar"><div id="fill"></div></div>
        <div id="stat" style="color:#0f0; font-size:12px; margin-top:5px;">TASKS: 0/1</div>
    </div>
    <canvas id="c"></canvas>
    <div id="joy"><div id="knob"></div></div>

    <div id="modal-engine" class="modal">
        <div class="panel">
            <h3>ENGINE ALIGNMENT</h3>
            <p style="font-size: 12px; color: #aaa;">PC: ARROWS | MOBILE: TILT</p>
            <div id="engine-gauge">
                <div id="target-zone"></div>
                <div id="needle"></div>
            </div>
            <p id="engine-msg">ALIGN TO TOP</p>
            <button class="btn" onclick="closeTask()">ABANDON</button>
        </div>
    </div>
</div>

<script>
    const q = document.getElementById('q');
    const c = document.getElementById('c');
    const ctx = c.getContext('2d');
    const needle = document.getElementById('needle');

    let player = { x: 0, y: 0, dx: 0, dy: 0, speed: 5, side: 1 };
    let imposter = { x: 100, y: 100, speed: 2.2 };
    let engineAngle = 90; // Starting angle
    let tasks = { count: 0, total: 1, done: [false] };
    let gameActive = false, inTask = false;
    let keys = {};

    // 1. Stealth Launch
    q.addEventListener('keypress', (e) => {
        if(e.key === "Enter" && q.value.toLowerCase().trim() === "/play") {
            document.getElementById('ui').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            gameActive = true; resize();
            player.x = c.width/2; player.y = c.height/2;
            loop();
        } else if(e.key === "Enter") {
            window.location.href = "https://www.bing.com/search?q=" + q.value;
        }
    });

    // 2. Controls
    window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
    window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

    // 3. Engine Tilt Logic (Mobile)
    window.addEventListener('deviceorientation', (e) => {
        if(inTask) {
            // Gamma is tilt left/right when in landscape
            engineAngle += e.gamma * 0.1;
        }
    });

    function closeTask() {
        document.getElementById('modal-engine').style.display = 'none';
        inTask = false;
    }

    function completeEngine() {
        if(!tasks.done[0]) {
            tasks.done[0] = true;
            tasks.count++;
            document.getElementById('fill').style.width = "100%";
            document.getElementById('stat').innerText = "TASKS: 1/1 - MISSION CLEAR";
            closeTask();
        }
    }

    // Joystick logic
    function moveJoy(e) {
        if(!gameActive || inTask) return;
        let t = e.touches ? e.touches[0] : e;
        let r = document.getElementById('joy').getBoundingClientRect();
        let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
        let dist = Math.min(50, Math.hypot(dx, dy));
        let ang = Math.atan2(dy, dx);
        player.dx = Math.cos(ang) * (dist / 10);
        player.dy = Math.sin(ang) * (dist / 10);
        document.getElementById('knob').style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
    }
    document.getElementById('joy').addEventListener('touchmove', moveJoy);
    document.getElementById('joy').addEventListener('touchend', () => { player.dx = 0; player.dy = 0; document.getElementById('knob').style.transform = "translate(0,0)"; });

    function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
    window.onresize = resize;

    function drawCrew(x, y, color, side) {
        ctx.fillStyle = color; ctx.strokeStyle = "black"; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.roundRect(x-15, y-20, 30, 40, [15, 15, 5, 5]); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "#83d5e6"; ctx.beginPath(); ctx.roundRect(side<0?x-18:x+2, y-12, 16, 10, 5); ctx.fill(); ctx.stroke();
    }

    function loop() {
        if(!gameActive) return;
        if(!inTask) {
            ctx.fillStyle = "#111"; ctx.fillRect(0,0,c.width, c.height);
            let mx = c.width/2, my = c.height/2;

            // --- MAP ---
            // Cafeteria (Center)
            ctx.fillStyle = "#3e444e"; ctx.fillRect(mx-150, my-100, 300, 200);
            // Reaction Room (Safe Room - Far Left)
            ctx.fillStyle = "#2c3e50"; ctx.fillRect(mx-500, my-80, 200, 160);
            // Engine Room (Bottom Left)
            ctx.fillStyle = "#444"; ctx.fillRect(mx-400, my+150, 150, 100);
            ctx.fillStyle = "yellow"; ctx.fillRect(mx-335, my+190, 20, 20); // Engine Task Square

            // --- MOVEMENT ---
            if(keys['w']) player.y -= player.speed; if(keys['s']) player.y += player.speed;
            if(keys['a']) { player.x -= player.speed; player.side = -1; }
            if(keys['d']) { player.x += player.speed; player.side = 1; }
            player.x += player.dx; player.y += player.dy;

            // --- NPC IMPOSTER ---
            let ang = Math.atan2(player.y - imposter.y, player.x - imposter.x);
            imposter.x += Math.cos(ang) * imposter.speed;
            imposter.y += Math.sin(ang) * imposter.speed;

            // Engine Task Trigger
            if(Math.hypot(player.x - (mx-325), player.y - (my+200)) < 30 && !tasks.done[0]) {
                inTask = true;
                document.getElementById('modal-engine').style.display = 'flex';
            }

            // Death Check
            if(Math.hypot(player.x - imposter.x, player.y - imposter.y) < 30) {
                gameActive = false; alert("DEFEAT"); location.reload();
            }

            drawCrew(imposter.x, imposter.y, "blue", 1);
            drawCrew(player.x, player.y, "red", player.side);
        } else {
            // --- ENGINE TASK PC CONTROLS ---
            if(keys['arrowleft']) engineAngle -= 2;
            if(keys['arrowright']) engineAngle += 2;
            needle.style.transform = `rotate(${engineAngle}deg)`;
            
            // Success Condition (Needle near 0 degrees / Top)
            if(Math.abs(engineAngle % 360) < 5) {
                completeEngine();
            }
        }
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
